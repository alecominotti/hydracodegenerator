{% extends 'hcg_app/index.html' %}
{% load static %}

{% block content %}

<script>





    $(document).ready(function () {

        var code = $(".code").text();
        var lines = code.split('\n');
        lines.splice(0, 2);
        var finalCode = lines.join('\n');
        $(".code").text(finalCode);

        $("#generate_code").click(function () { // start live session or send new code to one
            $("#loadinginfo").text("Generating new code...");
            $("#loadinginfo").addClass('text-primary').removeClass('text-success');
            $("#loadinginfo").show();

            var ignoredList = []
            var exclusiveSourcesList = []
            var exclusiveFunctionsList = []
            $("input:checkbox[name=ignore]:checked").each(function () {
                ignoredList.push($(this).val());
            });
            $("input:checkbox[name=exc_sources]:checked").each(function () {
                exclusiveSourcesList.push($(this).val());
            });
            $("input:checkbox[name=exc_functions]:checked").each(function () {
                exclusiveFunctionsList.push($(this).val());
            });

            var conflictingElements = [];
            for (var i = 0; i < ignoredList.length; i++) {
                if (exclusiveSourcesList.includes(ignoredList[i]) || exclusiveFunctionsList.includes(ignoredList[i])) {
                    conflictingElements.push(ignoredList[i]);
                }
            }
            if (conflictingElements.length > 0) {
                alert("Warning: you are trying to ignore elements selected as exclusive: " + conflictingElements.toString());
            } else {
                var url = "{{defaulturl}}"
                $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                    url = $("#custom_url").text();
                    console.log(url)
                });

                $.ajax({
                    url: '',
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        generate_code: true,
                        live_session_mode: $("#live_session_mode").val(),
                        code: $(".code").text(),
                        fmin: $("#fmin").val(),
                        fmax: $("#fmax").val(),
                        amin: $("#amin").val(),
                        amax: $("#amax").val(),
                        arrowprob: $("#arrowprob").val(),
                        mouseprob: $("#mouseprob").val(),
                        modulateitselfprob: $("#modulateitselfprob").val(),
                        ignored: ignoredList.toString(),
                        exclusivesources: exclusiveSourcesList.toString(),
                        exclusivefunctions: exclusiveFunctionsList.toString(),
                        hidecodestatus: $("#hide_code_status").val(),

                    },
                    dataType: 'json',
                    complete: function (data) {
                        $(".code").text(data['responseJSON']['code']);
                        $("#loadinginfo").addClass('text-success').removeClass('text-primary');
                        $("#loadinginfo").text("Code generated");
                        $("#loadinginfo").fadeOut(2000);
                    }
                });
            }
        });


        $("#live_switch").click(function () { // Start or finish live session 
            url = "{{defaulturl}}"
            if ($("#live_session_mode").val() == "0") {
                $("#custom_url_toggle").prop('disabled', true);
                $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                    $("#custom_url").prop('disabled', true);
                    url = $("#custom_url").val();
                });
                $("#loadinginfo").text("Starting Live Session Mode...");
            } else {
                $("#loadinginfo").text("Ending Live Session Mode...");
            }
            $("#loadinginfo").addClass('text-primary').removeClass('text-success');
            $("#loadinginfo").show();
            $.ajax({
                url: '',
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    live_switch: true,
                    code: $(".code").text(),
                    live_session_mode: $("#live_session_mode").val(),
                    hydraurl: url,

                },
                dataType: 'json',
                success: function (data) {
                    if ($("#live_session_mode").val() == "0") {
                        $("#live_session_mode").val("1");
                        $("#live_switch").text('Stop Live');
                        $("#loadinginfo").text("Live Session Mode started!");
                    } else {
                        $("#live_session_mode").val("0");
                        $("#live_switch").text('Go Live');
                        $("#loadinginfo").text("Live Session Mode ended");
                        $("#custom_url_toggle").prop('disabled', false);
                        $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                            $("#custom_url").prop('disabled', false);
                        });
                    }
                    $("#loadinginfo").addClass('text-success').removeClass('text-primary');
                    $("#loadinginfo").fadeOut(2000);
                },
                error: function () {                    
                    $("#live_session_mode").val("0");
                    $("#live_switch").text('Go Live');
                    $("#loadinginfo").text("Live Session Mode ended");
                    $("#custom_url_toggle").prop('disabled', false);
                    $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                        $("#custom_url").prop('disabled', false);
                    });
                    alert("Couldn't open Hydra in: " + url);                    
                }
            });

        });

        $("#hide_code_toggle").click(function () {
            $.ajax({
                url: 'hide_code',
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                dataType: 'json',
                complete: function (data) {
                    if ($("#hide_code_status").val() == "0") {
                        $("#hide_code_status").val("1");
                    } else {
                        $("#hide_code_status").val("0");
                    }
                }
            });
        });

        $("#custom_url_toggle").click(function () {
            $("#custom_url").prop('disabled', function () { this.disabled = !this.disabled; });
        });

    });

</script>

<form name="form" id="form" class="form">
    {% csrf_token %}
    <input name="fmin" id="fmin" placeholder="fmin" value="{{fmin}}">
    <input name="fmax" id="fmax" placeholder="fmax" value="{{fmax}}">
    <input name="amin" id="amin" placeholder="amin" value="{{amin}}">
    <input name="amax" id="amax" placeholder="amax" value="{{amax}}">

    <input name="arrowprob" id="arrowprob" placeholder="arrow prob" value="{{arrowprob}}">
    <input name="mouseprob" id="mouseprob" placeholder="mouse prob" value="{{mouseprob}}">
    <input name="modulateitselfprob" id="modulateitselfprob" placeholder="modulate itself prob"
        value="{{modulateitselfprob}}">
    <br>
    <br>
    <div class="row">
        <div class="col-3">
            Ignore:

            {% for item in sourcesandfunctions %}
            <lu>

                <li><input name="ignore" {% if item in defaultignorelist %} checked {% endif %} type="checkbox"
                        value="{{item}}">{{item}}</li>

            </lu>
            {% endfor %}


        </div>

        <div class="col-3">
            Exclusive sources:
            {% for item in allsources %}
            <lu>
                <li><input name="exc_sources" {% if item in defaultexclusivesources %} checked {% endif %}
                        type="checkbox" value="{{item}}">{{ item }}</li>
            </lu>
            {% endfor %}
        </div>

        <div class="col-3">
            Exclusive sources:
            {% for item in allfunctions %}
            <lu>
                <li><input name="exc_functions" {% if item in defaultexclusivefunctions %} checked {% endif %}
                        type="checkbox" value="{{item}}">{{ item }}</li>
            </lu>
            {% endfor %}
        </div>

    </div>

    <input type="hidden" name="live_session_mode" id="live_session_mode" value="0">
    <input type="hidden" name="hide_code_status" id="hide_code_status" value="0">

    <button name="generate_code" id="generate_code" type="button">Generate Code</button>
</form>

<form name="form2">
    {% csrf_token %}
    <button name="live_switch" id="live_switch" type="button">Go Live</button>
</form>

<input type="checkbox" name="custom_url_toggle" id="custom_url_toggle"></button>
<input disabled type="text" name="custom_url" id="custom_url" value="https://localhost:8000"></button>

<input type="checkbox" name="hide_code_toggle" id="hide_code_toggle">Hide code</button>

<div id="loadinginfo" class="text-primary font-weight-bold position-fixed" style="display:none">Loading new code...
</div>
<br>
<div class="code m-0 p-0 " style="white-space: pre-line" !important;">
    {% if code %}
    {{code}}
    {% endif %}
</div>

{% endblock %}