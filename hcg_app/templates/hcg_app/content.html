{% extends 'hcg_app/index.html' %}
{% load static %}

{% block content %}

<script>

    function removeCodeComments() {
        var code = $(".code").text();
        var lines = code.split('\n');
        lines.splice(0, 3);
        var finalCode = lines.join('\n');
        $(".code").text(finalCode);
    }

    function on() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("loader").style.display = "block";
    }

    function off() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("loader").style.display = "none";
    }

    $(document).ready(function () {

        removeCodeComments()

        $("#generate_code").click(function () { // start live session or send new code to one

            $("#loadinginfo").text("Generating new code...");
            $("#loadinginfo").addClass('text-primary').removeClass('text-success');
            $("#loadinginfo").show();

            var ignoredList = []
            var exclusiveSourcesList = []
            var exclusiveFunctionsList = []
            $('#ignorelist option:selected').each(function () {
                ignoredList.push($(this).val());
            });
            $('#exclusivesources option:selected').each(function () {
                exclusiveSourcesList.push($(this).val());
            });
            $('#exclusivefunctions option:selected').each(function () {
                exclusiveFunctionsList.push($(this).val());
            });

            var conflictingElements = [];
            for (var i = 0; i < ignoredList.length; i++) {
                if (exclusiveSourcesList.includes(ignoredList[i]) || exclusiveFunctionsList.includes(ignoredList[i])) {
                    conflictingElements.push(ignoredList[i]);
                }
            }
            if (conflictingElements.length > 0) {
                alert("Warning: you are trying to ignore elements selected as exclusive: " + conflictingElements.toString());
            } else {
                on()
                var url = "{{defaulturl}}"
                $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                    url = $("#custom_url").text();
                    console.log(url)
                });

                $.ajax({
                    url: '',
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        generate_code: true,
                        live_session_mode: $("#live_session_mode").val(),
                        code: $(".code").text(),
                        fmin: $("#fmin").val(),
                        fmax: $("#fmax").val(),
                        amin: $("#amin").val(),
                        amax: $("#amax").val(),
                        arrowprob: $("#arrowprob").val(),
                        mouseprob: $("#mouseprob").val(),
                        modulateitselfprob: $("#modulateitselfprob").val(),
                        ignored: ignoredList.toString(),
                        exclusivesources: exclusiveSourcesList.toString(),
                        exclusivefunctions: exclusiveFunctionsList.toString(),
                        hidecodestatus: $("#hide_code_status").val(),

                    },
                    dataType: 'json',
                    complete: function (data) {
                        $(".code").text(data['responseJSON']['code']);
                        removeCodeComments()
                        $("#loadinginfo").addClass('text-success').removeClass('text-primary');
                        $("#loadinginfo").text("Code generated");
                        $("#loadinginfo").fadeOut(2000);
                        off()
                    }
                });
            }
        });


        $("#live_switch").click(function () { // Start or finish live session 
            on()
            url = "{{defaulturl}}"
            if ($("#live_session_mode").val() == "0") {
                $("#custom_url_toggle").prop('disabled', true);
                $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                    $("#custom_url").prop('disabled', true);
                    url = $("#custom_url").val();
                });
                $("#loadinginfo").text("Starting Live Session Mode...");
            } else {
                $("#loadinginfo").text("Ending Live Session Mode...");
            }
            $("#loadinginfo").addClass('text-primary').removeClass('text-success');
            $("#loadinginfo").show();
            $.ajax({
                url: '',
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    live_switch: true,
                    code: $(".code").text(),
                    live_session_mode: $("#live_session_mode").val(),
                    hidecodestatus: $("#hide_code_status").val(),
                    hydraurl: url,

                },
                dataType: 'json',
                success: function (data) {
                    if ($("#live_session_mode").val() == "0") {
                        $("#live_session_mode").val("1");
                        $("#live_switch").text('Stop Live');
                        $("#loadinginfo").text("Live Session Mode started!");
                    } else {
                        $("#live_session_mode").val("0");
                        $("#live_switch").text('Go Live');
                        $("#loadinginfo").text("Live Session Mode ended");
                        $("#custom_url_toggle").prop('disabled', false);
                        $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                            $("#custom_url").prop('disabled', false);
                        });
                    }
                    $("#loadinginfo").addClass('text-success').removeClass('text-primary');
                    $("#loadinginfo").fadeOut(2000);
                    off()
                },
                error: function () {
                    $("#live_session_mode").val("0");
                    $("#live_switch").text('Go Live');
                    $("#loadinginfo").text("Live Session Mode ended");
                    $("#custom_url_toggle").prop('disabled', false);
                    $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                        $("#custom_url").prop('disabled', false);
                    });
                    alert("Couldn't open Hydra in: " + url);
                }
            });

        });

        $("#hide_code_toggle").click(function () {
            if ($("#hide_code_status").val() == "0") {
                $("#hide_code_status").val("1");
            } else {
                $("#hide_code_status").val("0");
            }
            if ($("#live_session_mode").val() == "1") {
                on()
                $.ajax({
                    url: 'hide_code',
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    complete: function (data) {
                        off()
                    }
                });
            }
        });

        $("#custom_url_toggle").click(function () {
            $("#custom_url").prop('disabled', function () { this.disabled = !this.disabled; });
            if ($("#custom_url").hasClass("text-secondary")) {
                $("#custom_url").removeClass("text-secondary")
            } else {
                $("#custom_url").addClass("text-secondary")
            }

        });

        function changeText() {
            if ($("#generate_code").text() == ">_ Generate Code") {
                $("#generate_code").text(">_ Generate Code_");
            }
            else {
                $("#generate_code").text(">_ Generate Code");
            }
        }

        function debounce(func) {
            var timer;
            return function (event) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(func, 500, event);
            };
        }

        window.addEventListener("resize", debounce(function (e) {
            if ($(window).width() < 1000) {
                $("#right-panel").addClass("bg-dark");
            }
        }));


        if ($(window).width() < 1280) {
            $("#right-panel").addClass("bg-dark");
        }

        var interval;

        $('#generate_code').mouseenter(function () {
            interval = setInterval(function () {
                if ($("#generate_code").text() == ">_ Generate Code") {
                    $("#generate_code").text("<_ Generate Code");
                }
                else {
                    $("#generate_code").text(">_ Generate Code");
                }
            }, 2000);
        });

        $('#generate_code').mouseleave(function () {
            clearInterval(interval);
            $("#generate_code").text(">_ Generate Code");
        }
        ).mouseleave();//trigger mouseleave to hide second div in beginning 



    });


</script>

<!-- ------------------------------------------------------------------------------------------------------>
<div class="container-fluid">

    <div class="row h-100">
        <!-- Main row -->
        <div class="col-lg-9 col-md-12 col-sm-12">
            <div class="row">
                <!-- parameters row-->
                <div class="col-lg-7 col-md-12 col-sm-12">
                    <!-- numbers and probs row -->
                    <form name="form" id="form" class="form">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="fmin">Min amount of Functions</label>
                                    <input type="number" min="0" class="form-control" name="fmin" id="fmin"
                                        placeholder="Amount of functions won't be less than this value"
                                        value="{{fmin}}">
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="fmax">Max amount of Functions</label>
                                    <input type="number" min="0" class="form-control" name="fmax" id="fmax"
                                        placeholder="Amount of functions won't be larger than this value"
                                        value="{{fmax}}">
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="amin">Min argument value</label>
                                    <input type="number" min="0" class="form-control" name="amin" id="amin"
                                        placeholder="Argument values won't be smaller than this value" value="{{amin}}">
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="amax">Max argument value</label>
                                    <input type="number" min="0" class="form-control" name="amax" id="amax"
                                        placeholder="Argument values won't be bigger than this value" value="{{amax}}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="arrowprob">Arrow function probability</label>
                                    <input type="number" min="0" max="100" class="form-control" name="arrowprob"
                                        id="arrowprob"
                                        placeholder="Probability of generating an arrow function as an argument [0-100]"
                                        value="{{arrowprob}}">
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="mouseprob">Mouse function probability</label>
                                    <input type="number" min="0" max="100" class="form-control" name="mouseprob"
                                        id="mouseprob"
                                        placeholder="Probability of generating a mouse arrow function as an argument [0-100]"
                                        value="{{mouseprob}}">
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="form-group">
                                    <label for="modulateitselfprob">Modulate itself probability</label>
                                    <input type="number" min="0" max="100" class="form-control"
                                        name="modulateitselfprob" id="modulateitselfprob"
                                        placeholder="Probability of modulating with itself [0-100]"
                                        value="{{modulateitselfprob}}">
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <!-- empty -->
                            </div>
                        </div>

                </div>
                <div class="col-lg-5 col-md-12 col-sm-12">
                    <!-- lists -->
                    <div class="row">
                        <div class="col-6 col-md-6 col-sm-6">
                            <div class="row">
                                Ignore List:
                                <select id="ignorelist" class="selectpicker p-1" multiple data-live-search="true"
                                    data-size="10" data-actions-box="true" multiple title="Elements to ignore..."
                                    multiple data-selected-text-format="count > 3">
                                    {% for item in sourcesandfunctions%}
                                    <option {% if item in defaultignorelist %} selected {% endif %}
                                        data-tokens="{{item}}">
                                        {{item}}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="row">
                                Exclusive Sources:
                                <select id="exclusivesources" class="selectpicker p-1" multiple data-live-search="true"
                                    data-size="10" data-actions-box="true" multiple title="Exclusive sources..."
                                    multiple data-selected-text-format="count > 3">
                                    {% for item in allsources%}
                                    <option {% if item in defaultexclusivesources %} selected {% endif %}
                                        data-tokens="{{item}}">
                                        {{item}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="row">
                                Exclusive Functions:
                                <select id="exclusivefunctions" class="selectpicker p-1" multiple
                                    data-live-search="true" data-size="10" data-actions-box="true" multiple
                                    title="Exclusive functions..." multiple data-selected-text-format="count > 3">
                                    {% for item in allfunctions%}
                                    <option {% if item in defaultexclusivefunctions %} selected {% endif %}
                                        data-tokens="{{item}}">
                                        {{item}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="live_session_mode" id="live_session_mode" value="0">
                <input type="hidden" name="hide_code_status" id="hide_code_status" value="0">
                </form>
            </div>

            <div class="row">
                <!-- code row-->
                <div class="form-group w-100 h-100 m-0">
                    <textarea class="code form-control" id="exampleFormControlTextarea1"
                        rows="12">{% if code %}{{code}}{% endif %}</textarea>
                </div>

            </div>

            <!-- <div class="cosde m-0 p-0 " style="white-space: pre-line" !important;"> -->


        </div>
        <div id="right-panel" class="col-lg-3 col-md-12 col-sm-12 border-left">
            <div class="row border-bottom logo-panel">


            </div>
            <div class="row button-panel">
                <div id="preloader">
                    <div class="mt-5" id="loader"></div>
                </div>
                <div id="overlay"></div>
                <div class="row m-0 w-100 mt-3 mb-4">
                    <div class="button button-1 w-75 text-center mx-auto" name="generate_code" id="generate_code">>_
                        Generate Code
                    </div>
                    <!-- <button class="mx-auto" name="generate_code" id="generate_code" type="button">>_ Generate Code</button> -->
                </div>
                <div class="row m-0 mb-3 w-100 mx-auto">
                    <div class="col-lg-7 col-md-2 col-sm-2 p-0 text-center align-self-center">
                        <p class="font-weight-bold h5 m-0 p-0 pl-2 ml-2 text-left" id="live_session_mode_text"
                            for="live_switch">
                            Live Session Mode</p>
                    </div>
                    <div class="col-lg-5 col-md-1 col-sm-1 text-center align-self-center">
                        <div class="row w-100">
                            <div class="custom-switch custom-switch-label-onoff w-100">
                                <input class="custom-switch-input" name="live_switch" id="live_switch" type="checkbox">
                                <label class="custom-switch-btn" for="live_switch"></label>
                            </div>
                        </div>
                    </div>
                    <!-- <button class="mx-auto" name="live_switch" id="live_switch" type="button">Go Live</button> -->

                </div>
                <div class="col-lg-7 col-md-2 col-sm-2 p-0 text-center align-self-center">
                    <p class="font-weight-bold h5 m-0 p-0 pl-2 ml-2 text-left" for="live_switch">Hide code</p>
                </div>
                <div class="col-lg-5 col-md-1 col-sm-1 text-center">
                    <div class="row w-100">
                        <div class="custom-switch custom-switch-label-onoff w-100">
                            <input class="custom-switch-input" name="hide_code_toggle" id="hide_code_toggle"
                                type="checkbox">
                            <label class="custom-switch-btn" for="hide_code_toggle"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row m-0 w-100 ">

                <div class="row m-0 w-0 w-15 mt-5 mb-1">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" name="custom_url_toggle"
                            id="custom_url_toggle">
                        <label class="custom-control-label" for="custom_url_toggle">Custom URL</label>
                    </div>
                </div>
                <div class="row m-0 w-100 mb-5">
                    <div class="input-group w-100 ml-0 mb-3">
                        <input disabled type="text" name="custom_url" id="custom_url" value="https://localhost:8000"
                            class="form-control text-secondary" aria-label="Set custom URL"
                            title="Set a custom URL, like localhost or another local IP:PORT">
                    </div>
                    <!-- <input class="ml-1" type="checkbox" name="custom_url_toggle" id="custom_url_toggle"></button>
                        <input class="mx-auto" disabled type="text" name="custom_url" id="custom_url"
                            value="https://localhost:8000"></button> -->
                    <!-- <div class="col-7 p-0 align-self-center">
                        <p class="font-weight-bold h5 m-0 p-0" for="live_switch">Hide code</p>
                    </div>
                    <div class="col-5">
                        <div class="custom-switch custom-switch-label-onoff">
                            <input class="custom-switch-input" name="hide_code_toggle" id="hide_code_toggle"
                                type="checkbox">
                            <label class="custom-switch-btn" for="hide_code_toggle"></label>
                        </div>
                    </div> -->


                    <!-- <div class="col-6 m-0 p-0 pl-2">
                        <p class="font-weight-bold m-0 p-0" for="hide_code_toggle">Hide code</p>
                    </div>
                    <div class="col-6 text-center">
                        <div class="custom-switch custom-switch-label-yesno">
                            <input class="custom-switch-input" name="hide_code_toggle" id="hide_code_toggle"
                                type="checkbox">
                            <label class="custom-switch-btn" for="hide_code_toggle"></label>
                        </div>
                    </div> -->
                    <!-- <input class="mx-100 ml-1" type="checkbox" name="hide_code_toggle" id="hide_code_toggle">Hide
                    Code</button> -->
                </div>
            </div>

            <!-- <div class="row">
                <button name="generate_code" id="generate_code" type="button">Generate Code</button>
            </div>
            <div class="row">
                <button name="live_switch" id="live_switch" type="button">Go Live</button>
            </div>
            <div class="row">
                <input type="checkbox" name="custom_url_toggle" id="custom_url_toggle"></button>
                <input disabled type="text" name="custom_url" id="custom_url" value="https://localhost:8000"></button>
            </div>
            <div class="row">
                <input type="checkbox" name="hide_code_toggle" id="hide_code_toggle">Hide code</button>
            </div>
            <div class="row">
                <div id="loadinginfo" class="text-primary font-weight-bold position-fixed" style="display:none">Loading
                    new
                    code...
                </div>
            </div> -->
            <!-- <div class="row">
                
            </div> -->

        </div>
    </div>

    <div class="row background-effect">

        <div class="waveWrapper waveAnimation">
            <div class="waveWrapperInner bgTop">
                <div class="wave waveTop"
                    style="background-image: url('http://front-end-noobs.com/jecko/img/wave-top.png')"></div>
            </div>
            <div class="waveWrapperInner bgMiddle">
                <div class="wave waveMiddle"
                    style="background-image: url('http://front-end-noobs.com/jecko/img/wave-mid.png')"></div>
            </div>
            <div class="waveWrapperInner bgBottom">
                <div class="wave waveBottom"
                    style="background-image: url('http://front-end-noobs.com/jecko/img/wave-bot.png')"></div>
            </div>
        </div>

    </div>

</div>
</div>
{% endblock %}