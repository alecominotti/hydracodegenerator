{% extends 'hcg_app/index.html' %}
{% load static %}

{% block content %}

<script>

    function removeCodeComments() {
        var code = $(".code").text();
        var lines = code.split('\n');
        lines.splice(0, 3);
        var finalCode = lines.join('\n');
        $(".code").text(finalCode);
    }

    function on() {
        /*document.getElementById("overlay").style.display = "block";
        document.getElementById("loader").style.display = "block";*/
    }

    function off() {
        /*document.getElementById("overlay").style.display = "none";
        document.getElementById("loader").style.display = "none";*/
    }

    $(document).ready(function () {

        removeCodeComments()

        $("#generate_code").click(function () { // start live session or send new code to one
            
            var ignoredList = []
            var exclusiveSourcesList = []
            var exclusiveFunctionsList = []
            $('#ignorelist option:selected').each(function () {
                ignoredList.push($(this).val());
            });
            $('#exclusivesources option:selected').each(function () {
                exclusiveSourcesList.push($(this).val());
            });
            $('#exclusivefunctions option:selected').each(function () {
                exclusiveFunctionsList.push($(this).val());
            });

            var conflictingElements = [];
            for (var i = 0; i < ignoredList.length; i++) {
                if (exclusiveSourcesList.includes(ignoredList[i]) || exclusiveFunctionsList.includes(ignoredList[i])) {
                    conflictingElements.push(ignoredList[i]);
                }
            }
            if (conflictingElements.length > 0) {
                alert("Error: you are trying to ignore elements selected as exclusive: " + conflictingElements.toString());
            } else {
                on()
                var url = "{{defaulturl}}"
                $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                    url = $("#custom_url").text();
                    console.log(url)
                });

                $.ajax({
                    url: '',
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        generate_code: true,
                        live_session_mode: $("#live_session_mode").val(),
                        code: $(".code").text(),
                        fmin: $("#fmin").val(),
                        fmax: $("#fmax").val(),
                        amin: $("#amin").val(),
                        amax: $("#amax").val(),
                        arrowprob: $("#arrowprob").val(),
                        mouseprob: $("#mouseprob").val(),
                        modulateitselfprob: $("#modulateitselfprob").val(),
                        ignored: ignoredList.toString(),
                        exclusivesources: exclusiveSourcesList.toString(),
                        exclusivefunctions: exclusiveFunctionsList.toString(),
                        hidecodestatus: $("#hide_code_status").val(),

                    },
                    dataType: 'json',
                    complete: function (data) {
                        $(".code").text(data['responseJSON']['code']);
                        removeCodeComments()
                        $("#loadinginfo").addClass('text-success').removeClass('text-primary');
                        $("#loadinginfo").text("Code generated");
                        $("#loadinginfo").fadeOut(2000);
                        off()
                    }
                });
            }
        });


        $("#live_switch").click(function () { // Start or finish live session 
            on()
            url = "{{defaulturl}}"
            if ($("#live_session_mode").val() == "0") {
                $("#custom_url_toggle").prop('disabled', true);
                $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                    $("#custom_url").prop('disabled', true);
                    url = $("#custom_url").val();
                });
                $("#loadinginfo").text("Starting Live Session Mode...");
            } else {
                $("#loadinginfo").text("Ending Live Session Mode...");
            }
            $("#loadinginfo").addClass('text-primary').removeClass('text-success');
            $("#loadinginfo").show();
            $.ajax({
                url: '',
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    live_switch: true,
                    code: $(".code").text(),
                    live_session_mode: $("#live_session_mode").val(),
                    hidecodestatus: $("#hide_code_status").val(),
                    hydraurl: url,

                },
                dataType: 'json',
                success: function (data) {
                    if ($("#live_session_mode").val() == "0") {
                        $("#live_session_mode").val("1");
                        $("#live_switch").text('Stop Live');
                        $("#loadinginfo").text("Live Session Mode started!");
                    } else {
                        $("#live_session_mode").val("0");
                        $("#live_switch").text('Go Live');
                        $("#loadinginfo").text("Live Session Mode ended");
                        $("#custom_url_toggle").prop('disabled', false);
                        $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                            $("#custom_url").prop('disabled', false);
                        });
                    }
                    $("#loadinginfo").addClass('text-success').removeClass('text-primary');
                    $("#loadinginfo").fadeOut(2000);
                    off()
                },
                error: function () {
                    $("#live_session_mode").val("0");
                    $("#live_switch").text('Go Live');
                    $("#loadinginfo").text("Live Session Mode ended");
                    $("#custom_url_toggle").prop('disabled', false);
                    $("input:checkbox[name=custom_url_toggle]:checked").each(function () {
                        $("#custom_url").prop('disabled', false);
                    });
                    alert("Couldn't open Hydra in: " + url);
                }
            });

        });

        $("#hide_code_toggle").click(function () {
            if ($("#hide_code_status").val() == "0") {
                $("#hide_code_status").val("1");
            } else {
                $("#hide_code_status").val("0");
            }
            if ($("#live_session_mode").val() == "1") {
                on()
                $.ajax({
                    url: 'hide_code',
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    complete: function (data) {
                        off()
                    }
                });
            }
        });

        $("#custom_url_toggle").click(function () {
            $("#custom_url").prop('disabled', function () { this.disabled = !this.disabled; });
            if ($("#custom_url").hasClass("text-secondary")) {
                $("#custom_url").removeClass("text-secondary")
                $("#custom_url").addClass("text-white")
            } else {
                $("#custom_url").removeClass("text-white")
                $("#custom_url").addClass("text-secondary")
            }

        });

        function changeText() {
            if ($("#generate_code").text() == ">_ Generate Code") {
                $("#generate_code").text(">_ Generate Code_");
            }
            else {
                $("#generate_code").text(">_ Generate Code");
            }
        }

        var interval;

        $('#generate_code').mouseenter(function () {
            interval = setInterval(function () {
                if ($("#generate_code").text() == ">_ Generate Code") {
                    $("#generate_code").text("<_ Generate Code");
                }
                else {
                    $("#generate_code").text(">_ Generate Code");
                }
            }, 2000);
        });

        $('#generate_code').mouseleave(function () {
            clearInterval(interval);
            $("#generate_code").text(">_ Generate Code");
        }
        ).mouseleave();//trigger mouseleave to hide second div in beginning 



    });


</script>

<!-- ------------------------------------------------------------------------------------------------------>
<div class="container-fluid m-0 p-0 m-0 w-100">
    <nav class="navbar navbar-dark navbar-expand-md bg-dark">
        <div class="container-fluid"><a class="navbar-brand" data-toggle="tooltip" data-bs-tooltip=""
                data-placement="right" href="#" style="font-family: 'Noto Sans', sans-serif;"
                title="The art of randomness">Hydra Code Generator</a><button data-toggle="collapse"
                class="navbar-toggler" data-target="#navcol-1"><span class="sr-only">Toggle navigation</span><span
                    class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navcol-1">
                <ul class="nav navbar-nav ml-auto">
                    <li class="nav-item" role="presentation"></li>
                    <li class="nav-item" role="presentation"></li>
                    <li class="nav-item" role="presentation"><a class="nav-link"
                            href="https://github.com/alecominotti/hydracodegenerator" target="_blank">Visit on
                            Github</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="row content w-100 m-0 p-0 border-bottom">
        <div class="col-12 col-sm-12 col-md-8 col-lg-9 col-xl-9 border-right m-0">
            <div class="row mt-2">
                <div class="col-sm-12 col-md-12 col-lg-2 col-xl-2">
                    <div class="form-group"><label>Min Function&nbsp; Amount</label><input type="number" min="0"
                            class="bg-dark form-control-sm w-75 form-control text-white"
                            data-toggle="tooltip" data-bs-tooltip="" placeholder="Number" name="fmin" id="fmin"
                            value="{{fmin}}"
                            title="The least amount of functions that can be generated"></div>
                    <div class="form-group"><label>Arrow Function Probability<br></label><input
                            class="bg-dark form-control-sm w-75 form-control text-white" type="number" min="0" max="100" name="arrowprob"
                            id="arrowprob" value="{{arrowprob}}"
                            data-toggle="tooltip" data-bs-tooltip="" placeholder="[0-100]" autocomplete="off"
                            title="The probability of generating an arrow function as an argument.<br>Ex.: &quot;() => Math.sin(time)&quot;"
                            data-html="true"></div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-2 col-xl-2">
                    <div class="form-group"><label>Max Function Amount<br></label><input
                            class="bg-dark form-control-sm w-75 form-control text-white" min="0" type="number"
                            name="fmax" id="fmax" data-toggle="tooltip" data-bs-tooltip="" placeholder="Number"
                            title="The maximum amount of functions that can be generated" value="{{fmax}}"></div>
                    <div class="form-group"><label>Mouse Function Probability<br></label><input
                            class="bg-dark form-control-sm w-75 form-control text-white" type="number" min="0" max="100" 
                            data-toggle="tooltip" data-bs-tooltip="" placeholder="[0-100]" name="mouseprob" id="mouseprob" value="{{mouseprob}}"
                            title="The probability of generating a mouse arrow function as an argument.<br>Ex.: &quot;() => mouse.x&quot;"
                            data-html="true"></div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-2 col-xl-2">
                    <div class="form-group"><label>Min Argument Value</label><input
                            class="bg-dark form-control-sm w-75 form-control text-white" type="number" min="0"
                            name="amin" id="amin" data-toggle="tooltip" data-bs-tooltip="" placeholder="Number"
                            title="The smallest value that can be generated as an argument" value="{{amin}}"></div>
                    <div class="form-group"><label>Modulate Itself Probability<br></label><input
                            class="bg-dark form-control-sm w-75 form-control text-white" type="number" min="0" max="100"
                            data-toggle="tooltip" data-bs-tooltip="" placeholder="[0-100]" name="modulateitselfprob" id="modulateitselfprob" value="{{modulateitselfprob}}"
                            title="The probability of passing &quot;o0&quot; as the first argument of any modulate function<br>Ex.: &quot;modulateScale(o0, 1)&quot;"
                            data-html="true"></div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-2 col-xl-2">
                    <div class="form-group"><label>Max Argument Value<br></label><input
                            class="bg-dark form-control-sm w-75 form-control text-white" min="0" type="number"
                            data-toggle="tooltip" data-bs-tooltip="" placeholder="Number" name="amax" id="amax"
                            title="The biggest value that can be generated as an argument" value="{{amax}}"></div>
                    <div class="form-group"><label style="opacity: 0.30;">Upcoming<br>Feature&nbsp;<br></label><input
                            class="bg-dark form-control-sm w-75 form-control" type="text" placeholder="-" disabled=""
                            style="filter: blur(0px);opacity: 0.30;"></div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-2 col-xl-2 mt-4">
                    <div class="form-group mx-auto"><label data-toggle="tooltip" data-bs-tooltip=""
                            title="Generated code will only have these selected sources">Exclusive sources</label>
                        <div>
                            <select id="exclusivesources" class="w-100 selectpicker" multiple data-live-search="true"
                                data-size="10" data-actions-box="true" multiple title="Sources..." multiple
                                data-selected-text-format="count > 3">
                                {% for item in allsources%}
                                    <option {% if item in defaultexclusivesources %} selected {% endif %} data-tokens="{{item}}">{{item}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group mt-4"><label data-toggle="tooltip" data-bs-tooltip=""
                            title="Generated code will only have these selected functions">Exclusive Functions</label>
                        <div>
                            <select id="exclusivefunctions" class="w-100 selectpicker" multiple data-live-search="true"
                                data-size="10" data-actions-box="true" multiple title="Functions..." multiple
                                data-selected-text-format="count > 3">
                                {% for item in allfunctions %}
                                    <option {% if item in defaultexclusivefunctions %} selected {% endif %} data-tokens="{{item}}">{{item}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col mt-4">
                    <div class="form-group"><label data-toggle="tooltip" data-bs-tooltip=""
                            title="Generated code will not have these selected elements">Ignored Elements</label>
                        <div class="qwe">
                            <select id="ignorelist" class="w-100 selectpicker" multiple data-live-search="true"
                                data-size="10" data-actions-box="true" multiple title="Elements..." multiple
                                data-selected-text-format="count > 3">
                                {% for item in sourcesandfunctions%}
                                    <option {% if item in defaultignorelist %} selected {% endif %} data-tokens="{{item}}">{{item}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row h-auto">
                <div class="col-12 m-0 p-0">
                    <textarea class="code h-100 w-100"
                        title="Generated Code"
                        spellcheck="false" autocomplete="off" readonly="" rows="12">{% if code %}{{code}}{% endif %}</textarea>
                    </div>
            </div>
        </div>
        <div class="col-12 col-sm-12 col-md-4 col-lg-3 col-xl-3 ml-0">
            <div class="row mt-3">
                <div class="col-6 text-center pr-0"><label class="col-form-label" data-toggle="tooltip"
                        data-bs-tooltip="" style="font-family: 'Noto Sans', sans-serif;"
                        title="Allows you to run and control Hydra in real time">Live Session Mode</label></div>
                <div class="col-6 text-center">
                    <div data-toggle="tooltip" data-placement="bottom"
                        title="Starts a Live Session, where code is written and executed in Hydra automatically"
                        class="m-0 p-0 custom-switch custom-switch-label-onoff ">
                        <input class="custom-switch-input" name="live_switch" id="live_switch"
                            type="checkbox">
                        <label class="custom-switch-btn" for="live_switch"></label>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-6 text-center pr-0"><label class="col-form-label" data-toggle="tooltip"
                        data-bs-tooltip="" style="font-family: 'Open Sans', sans-serif;"
                        title="Hides code in the Hydra window (In Live Session Mode)">Hide Code</label></div>
                <div class="col-6 text-center">
                    <div data-toggle="tooltip" data-placement="bottom" title="Hides or shows the code on Hydra"
                        class="m-0 p-0 custom-switch custom-switch-label-yesno button-sec">
                        <input class="custom-switch-input" name="hide_code_toggle" id="hide_code_toggle" type="checkbox">
                        <label class="custom-switch-btn" for="hide_code_toggle"></label>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-6 text-center pr-0"><label class="col-form-label" data-toggle="tooltip"
                        data-bs-tooltip="" style="font-family: 'Open Sans', sans-serif;"
                        title="Automatically executes in Hydra the new generated code (In Live Session Mode)">Auto
                        Send</label></div>
                <div class="col-6 text-center">
                    <div class="m-0 p-0 custom-switch custom-switch-label-yesno button-sec">
                        <input class="custom-switch-input" name="auto_send" id="auto_send" type="checkbox">
                        <label class="custom-switch-btn" for="auto_send"></label>
                    </div>
                </div>
            </div>
            <div class="row mt-4 text-center">
                <div class="col">
                    <div class="form-check custom-control custom-checkbox mb-1" data-toggle="tooltip" data-bs-tooltip=""
                        data-placement="right" title="Lets you run a Live Session in a locally running Hydra">
                        <input class="form-check-input custom-control-input" type="checkbox" name="custom_url_toggle" id="custom_url_toggle">
                            <label
                            class="form-check-label custom-control-label" for="custom_url_toggle">Custom Url</label></div>
                    <input class="bg-dark form-control-sm form-control w-75 mx-auto mb-4 text-secondary" type="url"
                        placeholder="https://localhost:8000" name="custom_url" id="custom_url" value="https://localhost:8000"
                        style="font-family: 'Open Sans', sans-serif;" disabled="">
                </div>
            </div>
            <div class="row mt-5 m-3 w-75 mx-auto">
                <div class="col m-0 p-0">
                    <div class="button button-1 text-center mx-auto" name="generate_code" id="generate_code">>_Generate
                        New Code</div>
                </div>
            </div>
            <div class="row mt-4 m-3 w-75 mx-auto">
                <div class="col m-0 p-0">
                    <div class="button button-1 text-center mx-auto" name="generate_code" id="generate_code">Send code
                        to Hydra ></div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" name="live_session_mode" id="live_session_mode" value="0">
    <input type="hidden" name="hide_code_status" id="hide_code_status" value="0">
</div>
<div class="footer-dark p-0 pt-3 pb-3">
    <footer>
        <div class="container">
            <div class="row">
                <div class="col item social"><a href="#"><i class="icon ion-social-snapchat"></i></a><a href="#"><i
                            class="icon ion-social-instagram"></i></a></div>
            </div>
            <p class="copyright pt-2">Ale Cominotti - 2020</p>
        </div>
    </footer>
</div>

{% endblock %}